#include <cex.h>

#ifdef _WIN32
#include "_os_win.c"
#define os$PATH_SEP '\\'
#else
#include "_os_posix.c"
#define os$PATH_SEP '/'
#endif

Exception
os_listdir(str_c path, sbuf_c* out)
{
    return os__listdir_(path, out);
}

Exception
os_getcwd(sbuf_c* out)
{
    return os__getcwd_(out);
}

const char*
os_getenv(const char* name, const char* deflt)
{
    const char* result = getenv(name);

    if (result == NULL) {
        result = deflt;
    }

    return result;
}

void
os_setenv(const char* name, const char* value, bool overwrite)
{
    setenv(name, value, overwrite);
}

void
os_unsetenv(const char* name)
{
    unsetenv(name);
}

Exception
os__path__exists(str_c path)
{
    return os__path__exists_(path);
}

Exception
os__path__join(sbuf_c* out, const char* format, ...)
{

    va_list va;
    va_start(va, format);
    sbuf.clear(out);
    Exc result = sbuf.vsprintf(out, format, va);
    va_end(va);
    return result;
}

str_c
os__path__splitext(str_c path, bool return_ext)
{
    if (path.len == 0) {
        return s$("");
    }

    size_t last_char_idx = path.len;
    size_t last_dot_idx = path.len;

    for (size_t i = path.len; i-- > 0;) {
        if (path.buf[i] == '.') {
            if (last_dot_idx == path.len) {
                last_dot_idx = i;
            }
        } else if (path.buf[i] == '/' || path.buf[i] == '\\') {
            break;
        } else if (last_dot_idx != path.len) {
            last_char_idx = i;
            break;
        }
    }
    if (last_char_idx < last_dot_idx) {
        if (return_ext) {
            return str.sub(path, last_dot_idx, 0);
        } else {
            return str.sub(path, 0, last_dot_idx);
        }

    } else {
        if (return_ext) {
            return s$("");
        } else {
            return path;
        }
    }
}


const struct __module__os os = {
    // Autogenerated by CEX
    // clang-format off
    .listdir = os_listdir,
    .getcwd = os_getcwd,
    .getenv = os_getenv,
    .setenv = os_setenv,
    .unsetenv = os_unsetenv,

    .path = {  // sub-module .path >>>
        .exists = os__path__exists,
        .join = os__path__join,
        .splitext = os__path__splitext,
    },  // sub-module .path <<<
    // clang-format on
};
